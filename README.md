# Arma Reforger - 拟真体力-速度系统

[![License: AGPL-3.0](https://img.shields.io/badge/License-AGPL--3.0-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)
[![Arma Reforger](https://img.shields.io/badge/Arma-Reforger-orange)](https://www.bohemia.net/games/arma-reforger)

一个结合体力和负重动态调整移动速度的拟真模组，基于精确的医学/生理学模型。

## 作者信息

- **作者**: ViVi141
- **邮箱**: 747384120@qq.com
- **许可证**: [AGPL-3.0](LICENSE)

## 许可证

本项目采用 [GNU Affero General Public License v3.0](LICENSE) 许可证。

## 功能说明

本模组根据玩家的体力值和负重动态调整移动速度，实现更真实的游戏体验。当体力充沛时，玩家可以全速移动；当体力下降时，移动速度会逐渐减慢。同时，负重也会影响移动速度。

**体力标准参考**：本模组的体力标准引用自 **ACFT (Army Combat Fitness Test)** 美国陆军战斗体能测试中22-26岁男性2英里测试100分用时15分27秒。

### 主要特性

- ✅ **双稳态-应激性能模型**：平台期（25%-100%体力）保持恒定速度，衰减期（0%-25%）平滑下降
  - 使用SmoothStep函数实现25%-5%的平滑过渡缓冲区，避免突兀的"撞墙"效果
  - 模拟意志力克服早期疲劳，生理崩溃时的平滑衰减
- ✅ **5秒阻尼过渡（"撞墙"瞬间优化）**：在体力触及25%临界点时，使用5秒时间阻尼过渡
  - 让玩家感觉角色"腿越来越重"，而不是"引擎突然断油"
  - 使用SmoothStep函数实现渐进式速度下降（从3.7 m/s逐渐降到约2.2 m/s）
- ✅ **坡度自适应步幅逻辑**：上坡时自动降低目标速度（坡度-速度负反馈）
  - 每度坡度降低2.5%速度，换取更持久的续航
  - 模拟现实中人爬坡时自动缩短步幅的行为
- ✅ **非线性坡度消耗**：使用幂函数代替线性增长
  - 小坡（5%以下）几乎无感，陡坡才真正吃力
  - 避免Everon缓坡频繁断气
- ✅ **生理上限保护**：体力消耗有生理上限（VO2 Max峰值）
  - 防止负重+坡度组合导致的数值爆炸
  - 每0.2秒最大消耗不超过0.02（每秒最多掉10%）
- ✅ **动态速度调整**：根据体力百分比动态调整移动速度（精确数学模型）
- ✅ **负重影响系统**：负重主要影响"油耗"（体力消耗）而非直接降低"最高档位"（速度）
  - 负重对速度的影响降低至20%，让30kg负重时仍能短时间跑3.7 m/s
- ✅ **移动类型系统**：支持Idle/Walk/Run/Sprint四种移动类型，每种有不同的速度和消耗特性
- ✅ **坡度影响系统**：上坡/下坡会影响体力消耗（基于[Pandolf模型](https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577)，包含负重×坡度交互项）
- ✅ **跳跃/翻越体力消耗**（v2.6.0优化）：跳跃和翻越动作会消耗额外体力
  - 跳跃基础消耗3.5%，翻越起始消耗2%，使用动态负重倍率
  - 连续跳跃惩罚机制（无氧欠债）：3秒内连续跳跃，每次额外增加50%消耗
  - 跳跃冷却机制：3秒冷却时间，防止重复触发
  - 低体力禁用：体力 < 10% 时禁用跳跃
- ✅ **Sprint机制**：Sprint速度比Run快30%（v2.6.0优化），但体力消耗增加3.0倍（v2.6.0优化）
- ✅ **健康状态系统**：训练有素者（fitness=1.0）能量效率提高18%，恢复速度增加25%（基于个性化运动建模）
- ✅ **累积疲劳系统**：长时间运动后，相同速度的消耗逐渐增加（基于个性化运动建模）
- ✅ **代谢适应系统**：根据运动强度动态调整能量效率（有氧区效率高，无氧区效率低但功率高）
- ✅ **多维交互模型**：速度×负重×坡度三维交互项，更真实地模拟复杂运动场景
- ✅ **重载下恢复优化**：负重时恢复速率提升，模拟深呼吸快速调整能力
- ✅ **趴下休息负重优化**（v2.6.0）：当角色趴下休息时，负重影响降至最低（地面支撑装备重量），重装兵趴下时能够快速恢复体力
- ✅ **实时状态显示**：每秒显示速度、体力、速度倍率、移动类型和坡度信息
- ✅ **精确医学模型**：基于[Pandolf能量消耗模型](https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577)和耐力下降模型，不使用近似
- ⚠️ **游泳体力管理**：空白（未实现）- 目前只处理陆地移动，游泳时的体力管理作为未来开发方向

## 项目结构

```
test_rubn_speed/
├── LICENSE                               # AGPL-3.0 许可证
├── README.md                             # 项目说明文档
├── AUTHORS.md                            # 作者信息
├── CONTRIBUTING.md                       # 贡献指南
├── CHANGELOG.md                          # 更新日志
├── .gitignore                            # Git 忽略文件配置
├── addon.gproj                           # Arma Reforger 项目配置文件
├── scripts/                              # EnforceScript 脚本目录
│   └── Game/
│       ├── PlayerBase.c                  # 主控制器组件（速度更新和状态显示）
│       └── Components/
│           └── Stamina/
│               ├── SCR_RealisticStaminaSystem.c  # 体力-速度系统核心（数学计算）
│               └── SCR_StaminaOverride.c          # 体力系统覆盖（拦截原生系统）
├── Prefabs/                              # 预制体文件
│   └── Characters/
│       └── Core/
│           └── Character_Base.et         # 角色基础预制体
└── tools/                                # 开发工具和脚本
    ├── simulate_stamina_system.py        # 基础趋势图生成脚本
    ├── generate_comprehensive_trends.py  # 综合趋势图生成脚本（包含移动类型对比）
    ├── multi_dimensional_analysis.py     # 多维度趋势分析脚本
    └── *.png                             # 生成的趋势图
```

## 技术实现

### 模型架构

本项目采用**精确的医学/生理学模型**，包括：
- **[Pandolf 能量消耗模型](https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577)**：完整的能量消耗计算公式
- **双稳态-应激性能模型**：模拟意志力克服早期疲劳
- **[个性化运动建模](https://doi.org/10.1371/journal.pcbi.1006073)**：健康状态、累积疲劳和代谢适应
- **多维交互模型**：速度、负重、坡度的综合影响

### 实现方式

- 使用 `modded class SCR_CharacterStaminaComponent` 扩展体力组件
- 使用 `modded class SCR_CharacterControllerComponent` 显示状态信息
- 通过 `OverrideMaxSpeed(fraction)` 动态设置最大速度倍数
- 每 0.2 秒更新一次速度，确保实时响应体力变化
- **使用精确的数学模型**：所有计算都基于精确的数学函数，不使用近似
- **使用完整的 [Pandolf 模型](https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577)**：始终使用 Pandolf 能量消耗模型（包含坡度项）
- **限制**：只处理陆地移动（Walk/Run/Sprint），游泳时的体力管理是空白的（未来开发方向）

### 速度计算逻辑

#### 1. 体力-速度关系模型（精确数学模型）

基于耐力下降模型（Fatigue-based speed model）：
**S(E) = S_max × E^α**

其中：
- S = 当前速度倍数
- E = 体力百分比 (0-1)
- α = 0.6（体力影响指数，基于医学文献）
- S_max = 0.885（目标最大速度倍数）

**精确计算结果**（无负重，优化后参数）：
- 100% 体力：92.0% 速度（4.78 m/s）
- 50% 体力：60.7% 速度（3.16 m/s）
- 25% 体力：40.0% 速度（2.08 m/s）
- 10% 体力：23.1% 速度（1.20 m/s）
- 0% 体力：15.0% 速度（0.78 m/s，最小速度限制）

**技术实现**：使用精确的幂函数计算（牛顿法计算5次方根），不使用平方根近似

#### 2. 负重影响系统（精确非线性模型）

基于 US Army 背包负重实验数据（Knapik et al., 1996）：

**精确数学模型**：
**速度惩罚 = β × (负重百分比)^γ**

其中：
- β = 0.40（负重速度惩罚系数）
- γ = 1.0（负重影响指数，可调整为 1.0-1.2 以模拟非线性）
- 负重百分比 = 当前重量 / 40.5 kg

**配置参数**：
- **最大负重**：40.5 kg（角色可以携带的最大重量）
- **战斗负重**：30.0 kg（战斗状态下的推荐负重阈值）
- **最大速度惩罚**：40%（当负重达到最大负重时）
- **战斗负重状态**：当负重超过 30 kg 时，可能影响战斗表现

**技术实现**：使用精确的幂函数计算，不使用线性近似

#### 3. 体力消耗模型（完整 Pandolf 模型）

**使用完整的 [Pandolf 能量消耗模型](https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577)**（Pandolf et al., 1977）：
- **公式**：`E = M·(2.7 + 3.2·(V-0.7)² + G·(0.23 + 1.34·V²))`
- **其中**：
  - E = 能量消耗率（W/kg）
  - M = 总重量（身体重量 + 负重）
  - V = 速度（m/s）
  - G = 坡度（坡度百分比，正数=上坡，负数=下坡）
- **坡度项**：`G·(0.23 + 1.34·V²)` 已直接整合在公式中
- **特点**：始终使用 Pandolf 模型，坡度项已包含在公式中，不需要额外的坡度倍数
- **参考文献**：Pandolf, K. B., Givoni, B. A., & Goldman, R. F. (1977). Predicting energy expenditure with loads while standing or walking very slowly. *Journal of Applied Physiology*, 43(4), 577-581.

**注意**：由于几乎没有完全平地的地形，系统始终使用包含坡度的完整 Pandolf 模型

#### 4. 跳跃和翻越体力消耗（v2.6.0优化）

**跳跃体力消耗**：
- 基础消耗：3.5%（v2.6.0优化，从3%提升）
- 动态负重倍率：`实际消耗 = 基础消耗 × (currentWeight / 90.0) ^ 1.5`
  - 30KG负重时，跳跃消耗约4.6%
  - 模拟负重对爆发性动作的额外负担
- 连续跳跃惩罚（无氧欠债）：3秒内连续跳跃，每次额外增加50%消耗
  - 第一次跳：3.5%，第二次跳：5.25%，第三次跳：7.0%
  - 有效防止"兔子跳"战术滥用
- 冷却机制：3秒冷却时间（15个更新周期），防止重复触发
- 低体力禁用：体力 < 10% 时禁用跳跃（肌肉在力竭时无法提供爆发力）
- 检测方式：使用动作监听器直接检测"Jump"输入动作

**翻越/攀爬体力消耗**：
- 初始消耗：2%（v2.6.0优化，从1.5%提升）
- 持续消耗：每秒1%（每0.2秒0.002）
- 动态负重倍率：`实际消耗 = 基础消耗 × (currentWeight / 90.0) ^ 1.5`
  - 30KG负重时，翻越起始消耗约2.7%
- 冷却机制：5秒内视为同一个翻越动作，不会重复消耗初始体力
- 检测方式：`IsClimbing()` 返回true

#### 5. Sprint机制（v2.6.0优化）

**Sprint速度计算**（统一增量模型）：
- Sprint速度 = Run速度 × (1 + 30%)（v2.6.0优化，从15%提升）
- Sprint完全基于Run的完整逻辑（双稳态-平台期、5秒阻尼过渡等）
- Sprint负重惩罚系数：0.15（Run为0.2），模拟爆发力克服阻力
- 最高速度限制：100%（游戏最大速度5.2 m/s）
- 仍然受体力和负重限制
- **效果**：28KG负重下，Run 3.6 m/s vs Sprint 4.7 m/s（差距 1.1 m/s）

**Sprint体力消耗**：
- Sprint消耗 = Run消耗 × 3.0倍（v2.6.0优化，从2.5倍提升）
- 基于医学研究：Sprint时的能量消耗约为Run的2-3倍
- 确保玩家不能长时间使用Sprint，只能作为战术爆发

**Sprint特点**：
- 速度比Run快30%（v2.6.0优化），适合短距离冲刺
- 体力消耗大幅增加（3.0倍），不适合长时间使用
- 确保在任何负重和体力状态下，Sprint都比Run快30%的固定阶梯
- 只有在满体力、无负重时才能达到最高速度

#### 6. 综合速度计算（精确模型）

```
Run速度 = 基础速度倍数（根据体力，精确计算） × (1 - 负重惩罚（精确计算）)
Sprint速度 = Run速度 × 1.30（v2.6.0优化，限制在100%）
Walk速度 = Run速度 × 0.7（限制在80%）
最终速度限制在 20%-100% 之间
```

**计算流程**（v2.6.0优化后参数）：
1. 计算基础速度倍数：`S_base = 0.920 × E^0.6`（E 为体力百分比）
2. 计算负重惩罚：`P_enc = 0.40 × (W/40.5)^1.0`（W 为当前重量）
3. 计算Run速度：`S_run = S_base × (1 - P_enc × 0.2)`（负重惩罚系数0.2）
4. 根据移动类型调整：
   - Run：`S_final = S_run`
   - Sprint：`S_final = (S_run × 1.30) - (P_enc × 0.15)`（v2.6.0优化：基于Run加乘，负重惩罚系数0.15）
   - Walk：`S_final = S_run × 0.7`（限制在80%）
   - Idle：`S_final = 0.0`
5. 应用限制：`S_final = clamp(S_final, 0.20, 1.0)`

**体力标准参考**：本模组的体力标准引用自 **ACFT (Army Combat Fitness Test)** 美国陆军战斗体能测试中22-26岁男性2英里测试100分用时15分27秒。

**优化目标**：2英里（3218.7米）在15分27秒（927秒）内完成  
**优化结果**：完成时间 925.8秒（15.43分钟），提前1.2秒完成 ✅

**初始体力**：角色初始体力为100%（满值）

### 关键参数

**体力系统参数：**
- `STAMINA_THRESHOLD_HIGH = 0.75`：高体力阈值（75%）
- `STAMINA_THRESHOLD_MED = 0.50`：中等体力阈值（50%）
- `STAMINA_THRESHOLD_LOW = 0.25`：低体力阈值（25%）

**速度倍数：**
- `SPEED_MULTIPLIER_FULL = 1.0`：100%体力时 100%速度
- `SPEED_MULTIPLIER_HIGH = 0.95`：高体力时 95%速度
- `SPEED_MULTIPLIER_MED = 0.85`：中等体力时 85%速度
- `SPEED_MULTIPLIER_LOW = 0.70`：低体力时 70%速度
- `SPEED_MULTIPLIER_EXHAUSTED = 0.55`：精疲力尽时 55%速度

**更新频率：**
- 速度更新间隔：200 毫秒（0.2 秒）
- 状态显示间隔：1000 毫秒（1 秒）

## 系统特性

### 体力-速度关系

系统会根据体力百分比动态调整速度，实现以下效果：

1. **体力充沛时（75-100%）**：
   - 速度倍数：95-100%
   - 几乎不影响移动速度
   - 适合长时间奔跑

2. **体力中等时（50-75%）**：
   - 速度倍数：85-95%
   - 轻微影响移动速度
   - 开始感到疲劳

3. **体力偏低时（25-50%）**：
   - 速度倍数：70-85%
   - 明显影响移动速度
   - 需要休息恢复体力

4. **精疲力尽时（0-25%）**：
   - 速度倍数：55-70%
   - 严重影响移动速度
   - 强烈建议休息

### 负重-速度关系

负重系统会根据携带物品的重量影响移动速度：

- **无负重（0 kg）**：无影响
- **轻度负重（0-15 kg）**：轻微影响，速度减少 < 15%
- **中度负重（15-30 kg）**：明显影响，速度减少 15-30%
- **战斗负重阈值（30 kg）**：达到战斗负重阈值，可能影响战斗表现
- **重度负重（30-40.5 kg）**：严重影响，速度减少 30-40%
- **最大负重（40.5 kg）**：达到最大负重，速度最多减少 40%

### 移动类型系统

系统支持四种陆地移动类型，每种类型有不同的速度特性和体力消耗：

**⚠️ 注意**：目前只处理陆地移动（Walk/Run/Sprint），游泳时的体力管理是空白的（未来开发方向）

#### 1. Idle（静止）
- **速度倍数**：0.0（完全静止）
- **体力消耗**：无（静止时恢复体力）
- **适用场景**：站立、蹲伏、休息

#### 2. Walk（行走）
- **速度倍数**：Run速度 × 0.7（约为Run的70%）
- **速度限制**：20% - 80%
- **体力消耗**：低（基础消耗 + 速度相关消耗）
- **适用场景**：正常移动、探索、节省体力

#### 3. Run（跑步）
- **速度倍数**：基础速度 × (1 - 负重惩罚)
- **速度限制**：20% - 100%
- **体力消耗**：中等（基于Pandolf模型）
- **适用场景**：正常行军、长距离移动
- **速度计算**：
  - 基础速度 = 目标速度倍数 × 体力^0.6
  - 最终速度 = 基础速度 × (1 - 负重惩罚)
  - 例如：满体力、无负重时，Run速度 = 4.78 m/s（92%）

#### 4. Sprint（冲刺）（v2.6.0优化）
- **速度倍数**：Run速度 × 1.30（v2.6.0优化，比Run快30%）
- **速度限制**：20% - 100%（最高速度 = 游戏最大速度5.2 m/s）
- **体力消耗**：高（Run消耗 × 3.0倍，v2.6.0优化）
- **适用场景**：追击、逃命、短距离冲刺
- **速度计算**（统一增量模型）：
  - Sprint速度 = Run速度 × (1 + 30%)（v2.6.0优化）
  - Sprint完全基于Run的完整逻辑（双稳态-平台期、5秒阻尼过渡等）
  - Sprint负重惩罚系数：0.15（Run为0.2），模拟爆发力克服阻力
  - 例如：Run速度80%时，Sprint速度 = 104%（限制在100%）
  - 28KG负重下，Run 3.6 m/s vs Sprint 4.7 m/s（差距 1.1 m/s）
  - 最高速度限制在5.2 m/s（基于现实情况：一般健康成年人的Sprint速度约20-30 km/h）
- **特点**：
  - 速度比Run快30%（v2.6.0优化），确保在任何负重状态下都有明显差距
  - 体力消耗大幅增加（3.0倍），不适合长时间使用
  - 确保在任何负重和体力状态下，Sprint都比Run快30%的固定阶梯
  - 只有在满体力、无负重时才能达到最高速度

**移动类型对比表**：

| 移动类型 | 速度倍数（相对于Run） | 最高速度限制 | 体力消耗倍数 | 适用场景 |
|---------|---------------------|------------|------------|---------|
| Idle | 0.0 | - | 0（恢复） | 静止、休息 |
| Walk | 0.7 | 80% | 1.0 | 正常移动、探索 |
| Run | 1.0 | 100% | 1.0 | 正常行军、长距离 |
| Sprint | 1.30（v2.6.0优化） | 100% | 3.0（v2.6.0优化） | 追击、逃命、短距离 |

### 状态显示

系统每秒输出一次状态信息，格式如下：

```
[RealisticSystem] 移动速度: 4.2 m/s | 体力: 65% | 速度倍率: 88% | 类型: Run | 坡度: 3.5° (上坡)
```

显示内容：
- **移动速度**：上一秒的水平移动速度（米/秒）
- **体力**：当前体力百分比（0-100%）
- **速度倍率**：当前速度倍数（相对于标准速度的百分比）
- **类型**：当前移动类型（Idle/Walk/Run/Sprint）
- **坡度**：当前移动坡度角度和方向（仅在坡度有意义时显示）

### 调试信息

系统每5秒输出一次详细调试信息（仅在客户端），格式如下：

```
[RealisticSystem] 调试: 类型=Sprint | 体力=100% | 基础速度倍数=0.92 | 负重惩罚=0.1 | 最终速度倍数=0.95 | 坡度=5.0% | 坡度: 5.0° (上坡) | Sprint消耗倍数: 2.5x | 负重: 15kg/40.5kg (最大:40.5kg, 战斗:30kg)
```

调试信息包含：
- **类型**：当前移动类型
- **体力**：当前体力百分比
- **基础速度倍数**：根据体力计算的基础速度倍数
- **负重惩罚**：负重对速度的影响
- **最终速度倍数**：考虑所有因素后的最终速度倍数
- **坡度**：坡度百分比（坡度已整合在Pandolf模型中）
- **坡度信息**：坡度角度和方向（仅在坡度有意义时显示）
- **Sprint消耗倍数**：Sprint时的体力消耗倍数（仅在Sprint时显示）
- **负重信息**：当前重量、最大重量、战斗负重阈值和状态

## 安装方法

1. 将整个 `test_rubn_speed` 文件夹复制到 Arma Reforger 工作台的 `addons` 目录
2. 在 Arma Reforger 工作台中打开项目
3. 编译模组
4. 在游戏中选择并启用此模组

## 使用方法

1. 启动游戏并加载模组
2. 系统会自动监控体力值和负重
3. 移动速度会根据体力百分比和负重自动调整
4. 状态信息会每秒一次输出到控制台，格式如下：
   ```
   [RealisticSystem] 移动速度: 4.2 m/s | 体力: 65% | 速度倍率: 88%
   ```

## 调整系统参数

### 修改体力分段速度

编辑 `scripts/Game/Components/Stamina/SCR_RealisticStaminaSystem.c` 文件：

```c
// 速度倍数（根据体力百分比）
protected const float SPEED_MULTIPLIER_FULL = 1.0;      // 100%体力：100%速度
protected const float SPEED_MULTIPLIER_HIGH = 0.95;     // 75-100%体力：95%速度
protected const float SPEED_MULTIPLIER_MED = 0.85;      // 50-75%体力：85%速度
protected const float SPEED_MULTIPLIER_LOW = 0.70;      // 25-50%体力：70%速度
protected const float SPEED_MULTIPLIER_EXHAUSTED = 0.55; // 0-25%体力：55%速度
```

### 修改负重影响

编辑 `scripts/Game/Components/Stamina/SCR_RealisticStaminaSystem.c` 文件：

```c
protected const float ENCUMBRANCE_SPEED_INFLUENCE = 0.3; // 负重对速度的影响系数（最多30%）
```

### 修改更新频率

编辑 `scripts/Game/Components/Stamina/SCR_RealisticStaminaSystem.c` 文件：

```c
// 启动定期更新（每0.2秒更新一次速度）
GetGame().GetCallqueue().CallLater(UpdateSpeedBasedOnStamina, 200, false);
```

修改 `200` 为其他值（单位：毫秒）可以调整更新频率。

## 系统优势

### 拟真体验

- **动态响应**：速度随体力实时变化，更真实
- **平滑过渡**：体力变化时速度平滑过渡，避免突兀
- **综合影响**：同时考虑体力和负重，更全面

### 游戏平衡

- **战略考虑**：需要管理体力和负重
- **资源管理**：携带物品需要权衡重量和速度
- **战术选择**：体力管理影响战术决策

## 已知问题与限制

### 当前限制

- **状态显示**：目前仅输出到控制台，尚未实现游戏内 UI 显示
- **速度限制**：速度倍数值大于 1.0 时会被引擎限制为 1.0（无法超过标准速度）
- **游泳体力管理**：⚠️ **空白（未实现）**
  - 目前模组只处理陆地移动（Walk/Run/Sprint）的体力管理
  - 游泳时的体力管理是完全空白的，游泳时体力系统不会工作
  - **未来方向**：计划添加游泳体力管理系统
    - 游泳的能量消耗远高于陆地移动（约3-5倍）
    - 需要检测游泳状态（水中移动）
    - 需要根据游泳速度和负重计算体力消耗
    - 可能需要考虑水温、波浪等环境因素

### 技术问题

- 需要测试 `GetStamina()` 和 `GetMaxStamina()` 方法是否可用（如果不可用，可能需要通过其他方式获取体力值）

## 开发说明

### 编译要求

- Arma Reforger 工作台
- EnforceScript 编译器

### 代码结构

**`scripts/Game/Components/Stamina/SCR_RealisticStaminaSystem.c`** - 体力-速度系统核心：
- `Pow()`: 精确计算幂函数（使用牛顿法，不使用近似）
- `CalculateSpeedMultiplierByStamina()`: 根据体力百分比精确计算速度倍数（S = 0.920 × E^0.6）
- `CalculateEncumbranceSpeedPenalty()`: 精确计算负重对速度的影响（P = 0.40 × (W/40.5)^1.0）
- `CalculateActionCost()`: 计算爆发性动作的体力消耗（v2.6.0新增）
  - 使用动态负重倍率：`实际消耗 = 基础消耗 × (currentWeight / 90.0) ^ 1.5`
  - 用于跳跃和翻越动作的消耗计算
- `CalculateEncumbrancePercent()`: 计算负重百分比
- `CalculateCombatEncumbrancePercent()`: 计算战斗负重百分比
- `IsOverCombatEncumbrance()`: 检查是否超过战斗负重阈值

**`scripts/Game/Components/Stamina/SCR_StaminaOverride.c`** - 体力系统覆盖：
- `OnStaminaDrain()`: 覆盖体力变化事件，拦截原生系统修改
- `SetTargetStamina()`: 设置目标体力值（唯一允许的修改方式）
- `MonitorStamina()`: 主动监控机制（每50ms检查一次）
- `CorrectStaminaToTarget()`: 纠正体力值到目标值

**`scripts/Game/PlayerBase.c`** - 主控制器组件：
- `OnInit()`: 初始化控制器组件，获取体力组件引用，禁用原生体力系统
- `UpdateSpeedBasedOnStamina()`: 根据体力、负重、移动类型和坡度精确更新速度（每0.2秒）
  - 检测移动类型（Idle/Walk/Run/Sprint）
  - 检测跳跃和翻越动作，应用额外体力消耗（v2.6.0优化：动态负重倍率、连续跳跃惩罚、冷却机制）
  - 计算坡度影响，调整体力消耗
  - 计算Sprint额外消耗（3.0倍，v2.6.0优化）
  - 实现Sprint统一增量模型（v2.6.0优化）：基于Run速度加乘，确保30%固定阶梯
  - 实现趴下休息负重优化（v2.6.0）：使用`ECharacterStance.PRONE`检测姿态
- `CollectSpeedSample()`: 每秒采集一次速度样本
- `DisplayStatusInfo()`: 显示速度、体力、速度倍率、移动类型和坡度信息

**精确体力消耗模型**（完整的 Pandolf 模型，包含健康状态、累积疲劳和代谢适应）：
- **完整 Pandolf 公式**：`E = M·(2.7 + 3.2·(V-0.7)² + G·(0.23 + 1.34·V²))`
  - E = 能量消耗率（W/kg）
  - M = 总重量（身体重量 + 负重）
  - V = 速度（m/s）
  - G = 坡度（坡度百分比，正数=上坡，负数=下坡）
- **坡度项**：`G·(0.23 + 1.34·V²)` 已直接整合在公式中，不需要单独的坡度倍数
- **效率因子和疲劳因子**：应用于完整 Pandolf 模型的结果
- **Sprint消耗倍数**：`sprint_multiplier = 2.5`（仅在Sprint时）

**效率因子**（基于[个性化运动建模](https://doi.org/10.1371/journal.pcbi.1006073)，Palumbo et al., 2018）：
- 健康状态效率因子：`fitness_efficiency_factor = 1.0 - 0.18 × fitness_level`（训练有素=1.0时，效率82%）
- 代谢适应效率因子：根据速度比动态调整
  - 有氧区（<60% VO2max）：`metabolic_efficiency_factor = 0.9`（更高效）
  - 混合区（60-80% VO2max）：`0.9 → 1.2`（线性插值）
  - 无氧区（≥80% VO2max）：`metabolic_efficiency_factor = 1.2`（低效但高功率）
- 综合效率因子：`total_efficiency_factor = fitness_efficiency_factor × metabolic_efficiency_factor`

**累积疲劳因子**（基于[个性化运动建模](https://doi.org/10.1371/journal.pcbi.1006073)，Palumbo et al., 2018）：
- 疲劳因子：`fatigue_factor = 1.0 + 0.015 × max(0, exercise_duration_minutes - 5.0)`
- 前5分钟无疲劳累积，之后每分钟增加1.5%消耗
- 最大疲劳因子：`2.0`（消耗最多增加100%）
- 静止时疲劳快速恢复（恢复速度是累积速度的2倍）

**体力恢复模型**（考虑健康状态）：
- 基础恢复率：`0.00015`（每0.2秒恢复0.015%）
- 健康状态恢复倍数：`fitness_recovery_multiplier = 1.0 + 0.25 × fitness_level`（训练有素=1.0时，恢复速度增加25%）
- 最终恢复率：`base_recovery_rate × fitness_recovery_multiplier`（训练有素时：0.0001875，每0.2秒恢复0.01875%）

## 参考文献

本项目基于以下学术研究和数学模型：

1. **Pandolf, K. B., Givoni, B. A., & Goldman, R. F. (1977)**. Predicting energy expenditure with loads while standing or walking very slowly. *Journal of Applied Physiology*, 43(4), 577-581. https://journals.physiology.org/doi/abs/10.1152/jappl.1977.43.4.577
   - **应用**：本项目使用完整的 Pandolf 能量消耗模型计算体力消耗
   - **公式**：`E = M·(2.7 + 3.2·(V-0.7)² + G·(0.23 + 1.34·V²))`
   - **说明**：坡度项 `G·(0.23 + 1.34·V²)` 已直接整合在公式中

2. **Palumbo, M. C., Morettini, M., Tieri, P., Diele, F., Sacchetti, M., & Castiglione, F. (2018)**. Personalizing physical exercise in a computational model of fuel homeostasis. *PLOS Computational Biology*, 14(4), e1006073. https://doi.org/10.1371/journal.pcbi.1006073
   - **应用**：本项目采用个性化运动建模方法，包括：
     - **健康状态系统**：训练有素者（fitness=1.0）能量效率提高18%，恢复速度增加25%
     - **累积疲劳系统**：长时间运动后，相同速度的消耗逐渐增加（每分钟增加1.5%）
     - **代谢适应系统**：根据运动强度动态调整能量效率（有氧区效率高，无氧区效率低但功率高）
   - **说明**：这些机制使体力系统能够更真实地模拟个体的生理响应

## 版本历史

- **v2.6.0** (当前版本) - Sprint速度系统优化和跳跃/翻越机制增强
  - 新增趴下休息时的负重优化：当角色趴下休息时，负重影响降至最低（地面支撑装备重量）
  - 新增跳跃冷却机制：3秒冷却时间，防止重复触发
  - 新增连续跳跃惩罚机制（无氧欠债）：3秒内连续跳跃，每次额外增加50%消耗
  - 新增低体力禁用跳跃：体力 < 10% 时禁用跳跃
  - Sprint速度系统优化（统一增量模型）：
    - Sprint速度增量从15%提升到30%，确保负重状态下仍有明显差距
    - Sprint计算完全基于Run的完整逻辑（双稳态-平台期、5秒阻尼过渡等）
    - Sprint负重惩罚系数从20%降为15%（模拟爆发力克服阻力）
    - 重构Sprint计算逻辑，确保始终比Run快30%的固定阶梯
    - 效果：28KG负重下，Run 3.6 m/s vs Sprint 4.7 m/s（差距 1.1 m/s）
  - Sprint体力消耗优化：从2.5倍提升到3.0倍，平衡速度提升带来的优势
  - 跳跃和翻越消耗优化（动态负重倍率）：
    - 跳跃基础消耗从3%提升到3.5%
    - 翻越起始消耗从1.5%提升到2%
    - 使用动态负重倍率：`实际消耗 = 基础消耗 × (currentWeight / 90.0) ^ 1.5`
  - 跳跃和翻越UI交互增强：跳跃后更新Exhaustion信号，触发深呼吸音效和视觉模糊效果

- **v2.5** - Pandolf 模型医疗级扩展和系统优化
  - 新增地形系数系统：根据地面类型动态调整消耗（铺装路面 1.0 → 深雪 2.1-3.0）
  - 新增静态负重站立消耗：负重下站立时减缓恢复速度（基于 Pandolf 静态项公式）
  - 新增 Santee 下坡修正模型：精确处理下坡时的体力消耗（超过 -15% 时需"刹车"）
  - 新增 Givoni-Goldman 跑步模式切换：速度 >2.2 m/s 时自动切换到跑步模型
  - 新增恢复启动延迟机制：负重下恢复需静止 3 秒后才生效，防止机制滥用
  - 新增网络同步容差优化：连续偏差累计触发（2 秒容差），速度插值平滑处理
  - 新增疲劳积累系统：超出最大消耗转化为疲劳，降低最大体力上限（最多 30%）
  - 新增 UI 信号桥接系统：让官方 UI 特效（视觉模糊、呼吸声）响应自定义体力系统状态
  - 性能优化：地形检测频率根据移动状态动态调整

- **v2.4** - 累积疲劳和代谢适应系统
  - 新增累积疲劳系统：长时间运动后，相同速度的消耗逐渐增加（基于[Palumbo et al., 2018](https://doi.org/10.1371/journal.pcbi.1006073)）
    - 前5分钟无疲劳累积
    - 之后每分钟增加1.5%消耗（30分钟后增加45%）
    - 最大疲劳因子2.0（消耗最多增加100%）
    - 静止时疲劳快速恢复（恢复速度是累积速度的2倍）
  - 新增代谢适应系统：根据运动强度动态调整能量效率（基于[Palumbo et al., 2018](https://doi.org/10.1371/journal.pcbi.1006073)）
    - 有氧区（<60% VO2max）：效率因子0.9（更高效，主要依赖脂肪）
    - 混合区（60-80% VO2max）：效率因子0.9→1.2（线性插值，糖原+脂肪混合）
    - 无氧区（≥80% VO2max）：效率因子1.2（低效但高功率，主要依赖糖原）
  - 优化综合效率因子：健康状态效率 × 代谢适应效率，更真实地模拟能量代谢
  - 更新所有Python脚本：同步累积疲劳和代谢适应系统到所有趋势图生成脚本

- **v2.3** - 健康状态系统和多维交互模型
  - 新增健康状态系统：实现[个性化运动建模](https://doi.org/10.1371/journal.pcbi.1006073)（基于Palumbo et al., 2018）
    - 训练有素者（fitness=1.0）能量效率提高18%（基础消耗、速度线性项、速度平方项均减少18%）
    - 训练有素者恢复速度增加25%
    - 角色设置为22岁男性，训练有素水平
  - 改进多维交互模型：添加速度×负重×坡度三维交互项
  - 更新所有Python脚本：同步健康状态系统到所有趋势图生成脚本

- **v2.2** - 移动类型和坡度系统
  - 添加移动类型系统（Idle/Walk/Run/Sprint）
  - 添加Sprint机制（速度+15%，消耗×2.5倍）
  - 添加坡度影响系统（上坡/下坡影响体力消耗）
  - 添加跳跃和翻越体力消耗
  - 增强状态显示（包含移动类型和坡度信息）
  - 增强调试信息（包含更多详细信息）
  - 优化代码结构，注释掉拦截体力系统的调试信息

- **v2.1** - 参数优化版本
  - 优化参数以达到2英里15分27秒目标
  - 速度倍数从0.885提升至0.920（满体力速度4.78 m/s）
  - 速度平方项系数从0.0003降低至0.0001
  - 完成时间：925.8秒（15.43分钟），提前1.2秒完成目标 ✅
  - 使用精确数学模型（α=0.6，Pandolf模型）

- **v2.0** - 拟真体力-速度系统
  - 实现动态速度调整系统（根据体力百分比）
  - 实现负重影响系统（负重影响速度）
  - 实现精确数学模型（不使用近似）
  - 实现综合状态显示（速度、体力、倍率）
  - 实现平滑速度过渡机制
  - 实现原生体力系统完全覆盖

- **v1.0** - 初始版本（已废弃）
  - 实现固定速度修改功能（50%）
  - 实现速度显示功能（每秒一次）

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

本项目采用 [GNU Affero General Public License v3.0](LICENSE) 许可证。

## 作者

- **ViVi141**
- Email: 747384120@qq.com

---

**注意：** 本模组修改了游戏的核心速度机制，可能会影响游戏体验。建议在测试环境中使用。
