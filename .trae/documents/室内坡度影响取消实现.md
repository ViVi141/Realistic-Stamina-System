# 室内坡度影响取消实现计划

## 实现目标
在检测到角色处于室内时，暂时取消坡度对速度和体力消耗的影响。

## 核心实现思路
1. **利用现有室内检测系统**：`SCR_EnvironmentFactor` 类已经实现了室内检测功能，通过 `IsUnderCover` 方法检测角色是否在建筑物内。
2. **修改坡度影响计算**：在计算坡度对体力消耗和速度的影响时，添加室内检测条件，若在室内则忽略坡度影响。
3. **更新相关计算方法**：需要修改以下关键方法：
   - `CalculateGradePercent`：计算坡度百分比时，若在室内则返回0坡度
   - `CalculateStaminaConsumption`：计算体力消耗时，若在室内则忽略坡度项
   - 可能需要修改速度计算相关方法，确保室内时坡度不影响速度

## 具体实现步骤

### 1. 添加室内检测方法到 `SCR_EnvironmentFactor` 类
确保 `SCR_EnvironmentFactor` 类有公开的 `IsIndoor` 方法供其他模块调用：
```cpp
// 检查角色是否在室内（公开方法）
bool IsIndoor()
{
    return m_bIsIndoor;
}
```

### 2. 修改 `CalculateGradePercent` 方法
在 `SCR_SpeedCalculation.c` 中修改 `CalculateGradePercent` 方法，添加室内检测：
```cpp
static GradeCalculationResult CalculateGradePercent(
    SCR_CharacterControllerComponent controller,
    float currentSpeed,
    JumpVaultDetector jumpVaultDetector,
    float slopeAngleDegrees)
{
    // ... 现有代码 ...
    
    // 检查是否在室内，如果是则返回0坡度
    // 获取环境因子组件
    EnvironmentFactor envFactor = controller.GetEnvironmentFactor();
    if (envFactor && envFactor.IsIndoor())
    {
        result.gradePercent = 0.0;
        result.slopeAngleDegrees = 0.0;
        return result;
    }
    
    // ... 现有坡度计算代码 ...
}
```

### 3. 修改体力消耗计算
在 `StaminaConsumptionCalculator.CalculateStaminaConsumption` 方法中，添加室内检测条件，若在室内则使用0坡度：
```cpp
static float CalculateStaminaConsumption(
    float currentSpeed,
    float currentWeight,
    float gradePercent,
    float terrainFactor,
    float postureMultiplier,
    float totalEfficiencyFactor,
    float fatigueFactor,
    float sprintMultiplier,
    float encumbranceStaminaDrainMultiplier,
    FatigueSystem fatigueSystem,
    float baseDrainRateByVelocity,
    EnvironmentFactor environmentFactor,
    IEntity owner)
{
    // 检查是否在室内，如果是则忽略坡度影响
    if (environmentFactor && environmentFactor.IsIndoor())
    {
        gradePercent = 0.0; // 室内时坡度为0
    }
    
    // ... 现有消耗计算代码 ...
}
```

### 4. 确保环境因子组件可用
在相关组件中确保能访问到 `EnvironmentFactor` 实例，以便调用室内检测方法。

## 预期效果
- 当角色处于室内时，坡度对速度和体力消耗的影响将被取消
- 室内检测基于建筑物边界框，准确可靠
- 保持现有系统的模块化设计，不破坏原有架构

## 测试建议
1. 在室内环境中测试不同坡度的移动，验证体力消耗和速度是否不受坡度影响
2. 在室外环境中测试，确保坡度影响仍正常工作
3. 测试室内外切换时的过渡效果，确保系统能正确响应环境变化

## 代码文件修改清单
- `scripts/Game/Components/Stamina/SCR_EnvironmentFactor.c`：添加公开的 `IsIndoor` 方法
- `scripts/Game/Components/Stamina/SCR_SpeedCalculation.c`：修改 `CalculateGradePercent` 方法，添加室内检测
- `scripts/Game/Components/Stamina/SCR_StaminaConsumptionCalculator.c`：修改 `CalculateStaminaConsumption` 方法，添加室内检测

这个实现计划充分利用了现有系统的功能，只需要在关键计算点添加室内检测条件，就能实现目标功能，同时保持代码的模块化和可维护性。