# 气温模型更新

日期: 2026-02-07

说明: 开发版本, 还未正式发布

## 概要
我们已将体力系统中的气温计算从“简单昼夜变换模型”升级为“物理模型”。新模型显式考虑地理与物理量，气温变化更贴近真实环境节奏。

## 变更内容
- 以物理能量平衡与步进计算取代固定昼夜余弦曲线。
- 地理与天文因素更明确：纬度、日照高度角、日出日落与季节变化会影响温度峰值与昼夜幅度。
- 天气与地表条件更显著：云量/降雨削弱短波辐照，地表湿度影响潜热散失，风速影响混合层高度与降温速度。
- 温度变化更平滑，升温与降温节奏更自然。

## 面向玩家：哪些因素会影响气温（简明） 🌤️❄️🌧️
下面这些你在游戏中能感受到，并会影响体感温度与体力恢复：

- **日照（时间、纬度、季节）**：正午阳光最强、夜晚最冷；靠近赤道昼夜幅度较小，靠近极区白昼/黑夜差异大。
- **云层 / 降雨**：阴天减弱白天升温、夜间减小辐射冷却；降雨还会使地表湿润并增加潜热损失（更难升温）。
- **地表湿度 / 泥泞**：湿润地表增加能量消耗（潜热），并影响奔跑/滑倒几率与体力消耗。
- **风速**：风大加速散热（更容易凉快下来），并提高混合高度使温度变化更平缓。
- **地表类型（反照率/发射率）**：雪地/白色表面反射较多阳光，黑色地面更易吸热。
- **混合层高度 / 海拔（近似）**：混合层影响热容，风与地形会改变温度响应速度。
- **大气颗粒（能见度/气溶胶）**：大量颗粒会减少直射短波，白天变凉。
- **月相 / 夜间星光**：月光对夜间辐照有小幅影响，但不是主导因素（只在满月夜可见轻微影响）。
- **室内 / 有遮挡**：躲在建筑/屋顶下可免受直接辐照与降雨影响，减轻温度惩罚。
- **服务器/管理员设置**：管理员可强制温度或覆盖经纬/时区，优先级高于自动估算。

### 如何观察与应对（玩家提示） 💡
- 中午外出尽量找遮挡或减缓移动以降低过热风险；夜间寒冷时留在室内并使用保暖装备以提高体力恢复。
- 下雨后地表湿润会影响恢复速度，减少裸露时间或寻找遮蔽物可减缓湿重累积。
- 风大时利用风向和遮挡减少风寒影响；高海拔/山地注意昼夜温差。

### 管理员 & 运维提示 🔧
- 若地图具有异常昼夜表现，可在服务器端显式设置经纬或时区（`SetCurrentLatitude/SetCurrentLongitude/SetTimeZoneOffset`）。
- 查看日志：`[RealisticSystem][TempStep]`（温度步进摘要）、`[RealisticSystem][LocationEstimate]`（经纬估算与置信度）、`[RealisticSystem][WeatherDebug]`（天气覆盖与引擎状态）。
- 若估算置信度低（日志显示 Conf < 0.5），建议管理员检查地图经纬或直接手动设置以保证温度一致性。

## 注意事项
- 新模型需要短时间“热平衡”后才会稳定输出更准确的气温。
- 若服务器强制温度或使用自定义天气，表现以服务器设定为准。

## 反馈
欢迎反馈地图、纬度、时间段、天气与体感差异，便于进一步调参。

## 因素与计算公式

以下内容按 C 代码逻辑与变量命名整理, 便于对照实现。

### 1) 输入与状态变量
- 天气/时间接口: `m_pCachedWeatherManager`
- 位置与时间: `GetCurrentLatitude()`, `GetTimeOfTheDay()`, `GetDate()`
- 时区: `m_bUseEngineTimezone`, `m_fTimeZoneOffsetHours`
- 温度源: `m_bUseEngineTemperature`, `m_bUseEngineWeather`
- 物理参数: `m_fSolarConstant`, `m_fAerosolOpticalDepth`, `m_fCloudBlockingCoeff`, `m_fAlbedo`, `m_fSurfaceEmissivity`, `m_fLECoef`, `m_fTemperatureMixingHeight`
- 环境量: `m_fCachedSurfaceWetness`, `m_fCachedRainIntensity`, `m_fCachedWindSpeed`
- 缓存温度: `m_fCachedSurfaceTemperature`, `m_fCachedTemperature`
- 常数: `STEFAN_BOLTZMANN`, `M_E`, `rho = 1.225`, `Cp = 1004`

### 2) 温度来源选择
- 若启用了引擎温度与天气（`m_bUseEngineTemperature && m_bUseEngineWeather`），系统优先使用引擎给出的日间最小/最大温度并在一天内插值得到当前基准温度；随后以固定步进（`m_fTempUpdateInterval`，默认 5 s）进行温度步进计算以更新近地表温度。
- 若未启用引擎温度，系统将通过物理稳态解（求解净辐射为零的温度）得到初始基准温度，然后以相同步进器对温度做显式时间积分更新。
- 在两种情况下，温度的最终输出由 `m_fCachedSurfaceTemperature` 提供，并作为系统的当前气温供后续使用。

### 3) StepTemperature 计算流程
概述：以时间步 dt（默认 5 s）为单位更新近地表温度，主要步骤如下：
- 读取当前时刻与日期，计算年日 n 与本地小时（根据时区设置调整）。
- 通过太阳高度角（solar zenith）与大气透过率估算到达地表的短波辐照（SW_down），并用经验大气发射率估算长波下行（LW_down）与地表长波发射（LW_up）。
- 计算净辐射 netRadiation = (1 - albedo) * SW_down + LW_down - LW_up，并扣除潜热损失 LE（与地表湿度线性相关）。
- 考虑风速对混合层高度的影响（风越大→混合层越高→温度响应越小），以有效混合高度为热容计算温度变化 dT：
  dT = Q_net * dt / (rho * Cp * H_eff)
- 更新并保护温度范围（-80°C 至 +60°C），写回缓存。  
关键公式：
- I0 = S * (1 + 0.033 cos(2π n / 365)) * cosθ
- τ ≈ exp(-AOD * m)（AOD = m_fAerosolOpticalDepth）
- LE ≈ m_fLECoef * surfaceWetness
- H_eff ≈ max(10 m, m_fTemperatureMixingHeight * (1 + wind/10))

### 4) AirMass 与 SolarCosZenith
- 太阳偏角（弧度）：δ ≈ 23.44° × sin(2π (284 + n) / 365)
- 天顶余弦（cosθ）：由纬度、年日与本地时刻计算（基于常见太阳几何公式），若 cosθ ≤ 0 则视为夜间。
- 空气质量（Air Mass，Kasten & Young）：用于在太阳低高度时放大大气光学厚度的经验表达式，以便计算清空透过率 τ。

### 5) InferCloudFactor
- 云因子由降雨强度、地表湿度与天气状态名称综合推断（范围 0..1）。
- 经验规则示例：雨强、湿润或标注为暴风/大雨的天气状态会将云因子推至接近 1；少云/多云则给出较低值。该值用于计算云遮挡短波的经验系数。

### 6) CalculateTemperatureFromAPI
- 当使用引擎温度时，使用引擎给出的日间最小/最大温度作为边界；若两者几乎相等（被锁定或失真），回退到物理稳态解。
- 在常规情形下以余弦函数插值获得一天内任意时刻的基准温度（白天峰值通常在下午 14:00 左右）。

### 7) CalculateEquilibriumTemperatureFromPhysics
- 初始稳态温度通过数值方法（例如二分法）求解 T 使得净辐射在地表近似为零。该过程在给定年日、时刻、纬度与云因子的条件下进行，并在异常情形时回退到简化的昼夜模型。

### 8) NetRadiationAtSurface
- 主要组成项：
  - 外大气顶端辐照（含年变化） I0 = S × (1 + 0.033 cos(2π n/365)) × cosθ
  - 大气透过率 τ ≈ exp(-AOD × m)，m 为空气质量（AirMass）
  - 短波到达地表 SW_down = I0 × τ × (1 - cloudBlocking)
  - 长波下行与地表发射分别由经验发射率估计，LW_down 与 LW_up 计算净长波项
  - 潜热项 LE 与地表湿度线性相关
- 净辐射 net = (1 - albedo) × SW_down + LW_down - LW_up - LE，作为热源项用于计算温度变化。

### 9) 经纬度估算（基于日出/日落） 🔧
- 目的：若地图未显式提供纬度/经度或时区，模块将尝试用引擎提供的日出/日落时间、日期和时区偏移估算 **纬度 (`m_fLatitude`)** 与 **经度 (`m_fLongitude`)**，并输出置信度（0.0–1.0）。

- 输入：`GetSunriseHour() = sr`（小时，0-24）、`GetSunsetHour() = ss`（小时，0-24）、`GetDate()` → 年/月/日、`m_fTimeZoneOffsetHours`。

- 步骤与公式：
  1. 处理跨日：若 `ss < sr` 则 `ss += 24`。
  2. 昼长 L = ss - sr（小时）。
  3. 太阳日出小时角 ω0_deg = 7.5 * L（度）。
  4. 年日 n = DayOfYear(year, month, day)，太阳偏角 decl = SolarDeclination(n)（弧度）。
  5. 由公式 cos(ω0) = - tan(φ) * tan(decl) 推导：
     tan(φ) = -cos(ω0) / tan(decl)；φ = atan(tan(φ)) → 纬度（度）。
     注意：所有三角函数在内部使用弧度。
  6. 局部太阳中天 t_noon_local = (sr + ss) / 2（小时，标准化到0–24）。
     太阳中天在 UTC 的时刻 solarNoonUTC = t_noon_local - tz（tz = m_fTimeZoneOffsetHours）。
     经度 λ = 15 * (12 - solarNoonUTC)（度），并规范化到 [-180,180]。

- 置信度评分（示例实现逻辑）：
  - 初始 conf = 1.0
  - 减分项：云量/雨强（因云会延迟/提前可见日出日落），春/秋分附近（tan(decl)≈0 导致数值不稳定），极昼/极夜附近的昼长异常。
  - 最终 clamp 到 [0,1]。模块同时将估算结果写入 `m_fLatitude` 与 `m_fLongitude` 并在日志中打印估算值与置信度。

- 覆盖与控制：
  - 若地图/服务器明确设置了 `m_fLatitude`/`m_fLongitude`（或引擎提供可靠的纬度），估算不会覆盖显式配置。
  - 管理员可通过配置 `m_fTimeZoneOffsetHours` 或 `m_bUseEngineTimezone` 控制中天时刻的时区解释，或直接在配置中硬编码经纬以禁用估算。

- 限制与注意事项 ⚠️
  - 月相或单一观测无法可靠推断经纬；日出/日落与日期信息是可行但仍有不确定性。
  - 在高纬度（接近极圈）与春/秋分附近估算不稳定，建议管理员在这些区域显式配置经纬。
  - 天气严重遮挡（暴雨/大雾）会显著降低置信度；模块会输出低置信度以供上层决策（例如使用默认值或请求管理员输入）。

- 与气温模型集成：估算到的经纬将用于 `SolarCosZenith(...)`、`CalculateEquilibriumTemperatureFromPhysics()` 等函数，能补充地图未提供的地理参数，从而改善昼夜及季节温度变化的物理一致性。

- 进阶：基于引擎天文 API 的网格搜索细化 🔭
  - 实现要点：若初始解析估算置信度不足，模组会在经纬空间上做分层网格搜索（粗 5° 步长 → 细化到 0.1°）并在每个候选点上调用引擎的 `GetSunriseHourForDate` / `GetSunsetHourForDate` / `GetMoonPhaseForDate` 来计算理论昼长、中天与月相，再与观测值比较以求最小误差。
  - 优点：利用引擎对不同经纬的精确天文计算（考虑极地无日出/日落等边界），在云层或观测噪声不太严重时能显著提高经纬估计的准确性。
  - 代价：网格搜索会在初始化或置信较低时进行一次性计算（性能可控）；失败/低置信时会保留解析解或提示管理员干预。

### 10) 月亮与天文约束（辅助） 🌙🔭
- 背景：引擎提供的天文信息（不仅是月相，还有天体方向向量）可以作为对日出/日落解析估算的额外约束，从而在一些边界情形提高置信度。

- 引擎接口（已使用/可用）：
  - `GetSunriseHour()` / `GetSunsetHour()`（简洁观测）
  - `GetSunriseHourForDate(year,month,day,lat,lon,tz,dst,out float hour)` / `GetSunsetHourForDate(...)`（用于任意经纬的理论计算）
  - `GetMoonPhase(float timeOfTheDay24)`、`GetMoonPhaseForDate(year,month,day,timeOfDay,timeZone,dst)`（月相）
  - `GetCurrentSunMoonDirAndPhase(out vector outSunDir, out vector outMoonDir, out float outMoonPhase01)`（返回当前太阳/月亮方向向量与月相）

- 实现细节（当前实现）：
  1. 在 `Initialize()` 时先执行解析估算（见 §9）。若解析置信度 < 0.9，则触发 **网格搜索细化**（粗→细分层）。
  2. 对于每个候选经纬，调用 `GetSunriseHourForDate` / `GetSunsetHourForDate` / `GetMoonPhaseForDate`，计算理论昼长、中天时刻和月相，并与观测值计算加权误差（白昼长度、中天时差、月相差异）。
  3. 选取误差最小的候选点并以误差/云因子计算最终置信度（写回 `m_fLatitude` / `m_fLongitude`）。
  4. 若引擎暴露 `GetCurrentSunMoonDirAndPhase`，未来可选用月亮方向向量与候选点在天球上的理论位置做向量匹配以进一步缩小不确定区（注意：需要核对游戏世界坐标系与地理天球基准的映射）。

- 日志与监控（示例）：
  - 初始解析：`[RealisticSystem][LocationEstimate] Estimated Lat=xx.x Lon=yy.y Conf=0.67 (initial)`
  - 网格细化：`[RealisticSystem][LocationEstimate] Refined Lat=xx.x Lon=yy.y Conf=0.82 (improved)`
  - 详细报告（若启用 Debug）：`[RealisticSystem] EstimateLatLongAstronomy: lat=xx.x lon=yy.y conf=0.82 bestErr=1.23`

- 如何禁用/覆盖：
  - 若地图或管理员在 `SCR_RSS_Settings` 中显式设定 `m_fLatitude`/`m_fLongitude` 或引擎返回可靠纬度，经纬估算将不会覆盖这些值；
  - 管理员可通过设置 `m_fTimeZoneOffsetHours` 或 `m_bUseEngineTimezone` 来控制中天时刻的时区解释；
  - 如需完全禁用自动估算，请在配置中硬编码经纬或在运行时直接调用引擎的 `SetCurrentLatitude/SetCurrentLongitude`。

- 局限性与注意事项 ⚠️
  - 网格搜索依赖引擎返回的天文计算（优点是可靠），但若当前观测受强云/降雨干扰或处于极地季节性无日出/日落时（`GetSunriseHourForDate` 返回 false），估算置信度会明显下降。
  - 月相本身对经度/纬度约束较弱（但可帮助在某些日期缩小解集），更强的约束来源是天体方位（需要额外实现向量反解）。
  - 数值/数学不稳定性（如春/秋分临近时 tan(decl)≈0）依然会降低解析公式的稳定性，代码中对此处加入了保护并降低置信度。

- 与气温模型的关系：估算出的经纬用于 `SolarCosZenith(...)`、`CalculateEquilibriumTemperatureFromPhysics()` 以及 StepTemperature 的太阳辐照项，使得昼夜与季节驱动的温度变化更贴近地图的地理属性。

---

如果你愿意，我可以接着把这节内容翻译并同步到英文版 `docs/Temperature_Model_Update.md`，并加入一小节“运维检查清单”（建议检查项与快速修复命令）。
