# 更新日志

所有重要的项目变更都会记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/),
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [2.11.0] - 2026-01-20

### 新增
- **进一步模块化重构（Advanced Modular Refactoring）**
  - **SCR_SwimmingState.c** - 游泳状态管理模块（121行）
    - 游泳状态检测逻辑
    - 湿重跟踪和计算逻辑
    - 总湿重计算逻辑
  - **SCR_StaminaUpdateCoordinator.c** - 体力更新协调器模块（333行）
    - 速度更新协调逻辑
    - 位置差分测速逻辑
    - 基础消耗率计算（游泳/陆地）
    - 体力更新协调（消耗/恢复）

### 改进
- **代码精简优化**
  - PlayerBase.c: 从 1362 行减少到 817 行（减少 545 行，约 40%）
  - UpdateSpeedBasedOnStamina() 函数从约 946 行精简到约 700 行
  - 大幅提升代码可读性和可维护性
- **调试信息输出优化**
  - 扩展 SCR_DebugDisplay.c 模块（从 145 行扩展到 352 行）
  - 新增 `FormatEnvironmentInfo()` 方法：统一格式化环境因子信息
  - 新增 `OutputDebugInfo()` 方法：统一调试信息输出接口（使用参数结构体，解决参数数量限制）
  - 新增 `OutputStatusInfo()` 方法：统一状态信息输出接口
  - 所有调试信息格式化逻辑集中在 DebugDisplay 模块
- **坡度检测模块化**
  - 扩展 SCR_SpeedCalculation.c 模块
  - 新增 `CalculateGradePercent()` 方法：统一坡度检测和计算逻辑
  - 考虑攀爬和跳跃状态的坡度检测

### 技术改进
- 实现游泳状态管理模块化架构（SwimmingStateManager类）
- 实现体力更新协调器模块化架构（StaminaUpdateCoordinator类）
- 实现调试信息统一管理（DebugDisplay类扩展）
- 优化代码组织，每个模块职责单一，符合单一职责原则
- 提高代码复用性和可测试性

### 代码统计
- **PlayerBase.c**: 1362行 → 817行（减少40%）
- **SCR_SwimmingState.c**: 新建（121行）
- **SCR_StaminaUpdateCoordinator.c**: 新建（333行）
- **SCR_DebugDisplay.c**: 145行 → 352行（扩展）
- **SCR_SpeedCalculation.c**: 128行 → 163行（扩展）

## [2.10.0] - 2026-01-19

### 新增
- **环境因子系统（Environmental Stress System）**
  - **热应激系统（Heat Stress）**：基于时间段的热应激影响
    - 10:00-14:00 逐渐增加，14:00-18:00 逐渐减少
    - 峰值（14:00）时体力消耗增加30%
    - 室内豁免：在室内（头顶有遮蔽物）时热应激减少50%
    - 热应激不仅影响体力消耗，还影响恢复速度（高温让人休息不回来）
  - **降雨湿重系统（Rain Weight）**：下雨时衣服和背包增重
    - 小雨：2kg，中雨：5kg，暴雨：8kg
    - 停止降雨后湿重逐渐衰减（60秒内完全消失，使用二次方衰减模拟自然蒸发）
    - 湿重饱和上限：总湿重（游泳+降雨）不超过10kg，防止数值爆炸
    - 加权平均：游泳湿重权重0.6，降雨湿重权重0.4（更真实的物理模型）
  - **室内检测系统**：向上射线检测10米，判断角色是否在室内
    - 用于热应激室内豁免
    - 每5秒检测一次（与环境因子更新同步）
  - **SCR_EnvironmentFactor.c** - 环境因子模块（355行）
    - 环境因子检测和计算
    - 热应激倍数计算（考虑室内豁免）
    - 降雨湿重计算（基于天气状态名称）
    - 防御性编程：自动重新获取丢失的天气管理器

### 改进
- **代码精简优化**
  - 删除服务器端验证相关代码（永远不会执行）
    - 删除 `CalculateServerSpeedMultiplier` 方法
    - 删除 `ValidateStaminaState` 方法
    - 删除所有 RPC 方法（`RPC_UpdateStaminaState`、`RPC_SyncStaminaState`）
    - 删除网络同步 RPC 调用代码
    - 删除速度插值平滑处理代码
  - 删除无用的兼容性代码
    - 删除手动查找体力组件的备用代码
    - 删除如果没有体力组件引用时使用 `GetStamina()` 的备用代码
  - 删除无用的模块引用（`NetworkSyncManager`）
  - 简化客户端检查逻辑（直接检查是否为本地控制的玩家）
  - **代码减少约200+行**，提高可读性和维护性
- **调试信息增强**
  - 在每5秒的调试输出中新增完整的环境因子信息
    - 当前时间（格式：HH:MM）
    - 热应激倍数（1.0-1.3x）
    - 降雨信息（降雨类型、湿重、强度）
    - 室内/室外状态
    - 游泳湿重
  - 环境因子模块新增调试方法
    - `GetCurrentHour()` - 获取当前时间（小时）
    - `IsIndoor()` - 检查是否在室内
    - `GetRainIntensity()` - 获取降雨强度
    - `IsRaining()` - 检查是否正在下雨

### 技术改进
- 实现环境因子模块化架构（EnvironmentFactor类）
- 实现热应激时间段计算（10:00-18:00）
- 实现室内检测（向上射线追踪）
- 实现降雨湿重计算（基于天气状态名称）
- 实现湿重饱和上限机制（防止叠加导致数值爆炸）
- 实现二次方衰减（模拟自然蒸发过程）
- 优化环境因子检测频率（每5秒更新一次）

### 修复
- 修复 EnforceScript 三元运算符语法错误（改为 if-else 语句）
- 修复 `rainWeight` 变量定义位置问题（移到了使用之前）

## [2.9.0]

### 新增
- **深度模块化重构（Deep Modular Refactoring）**
  - 新增4个核心计算模块，进一步拆分复杂逻辑
  - **SCR_SpeedCalculation.c** - 速度计算模块（129行）
    - 基础速度倍数计算
    - 坡度自适应目标速度计算
    - 最终速度倍数计算（根据移动类型）
  - **SCR_StaminaConsumption.c** - 体力消耗计算模块（187行）
    - Pandolf模型计算
    - 姿态修正计算
    - 代谢适应效率因子计算
    - 健康状态效率因子计算
    - 综合体力消耗率计算
  - **SCR_StaminaRecovery.c** - 体力恢复计算模块（122行）
    - EPOC延迟状态管理
    - EPOC消耗计算
    - 多维度恢复率计算
    - 恢复重量计算（考虑姿态优化）
  - **SCR_DebugDisplay.c** - 调试信息显示模块（141行）
    - 移动类型格式化
    - 坡度信息格式化
    - Sprint信息格式化
    - 负重信息格式化
    - 地形信息格式化
    - 调试消息构建

### 改进
- **代码结构大幅优化**
  - PlayerBase.c: 1554行 → 1283行（减少271行，约17%）
  - UpdateSpeedBasedOnStamina函数从990行减少到更易管理的长度
  - 主函数逻辑更清晰，可读性显著提升
- **模块化架构完善**
  - 所有复杂计算逻辑已提取到独立模块
  - 每个模块职责单一，符合单一职责原则
  - 代码更易于维护和测试
- **游戏工作台兼容性**
  - 解决了游戏工作台对多行代码支持较差的问题
  - 每个模块文件大小适中，便于编辑和查看
  - 代码结构更适合Arma Reforger工作台环境

### 技术改进
- 实现深度模块化架构，提高代码可维护性
- 提取速度计算逻辑到独立模块（SpeedCalculation）
- 提取体力消耗计算逻辑到独立模块（StaminaConsumption）
- 提取体力恢复计算逻辑到独立模块（StaminaRecovery）
- 提取调试显示逻辑到独立模块（DebugDisplay）
- 优化代码组织，每个模块专注于单一功能领域

### 修复
- 修复EnforceScript语法兼容性问题（三元运算符改为if-else语句）
- 修复模块间参数传递问题（使用ref参数替代out参数）

## [2.9.0]

### 新增
- **游泳体力管理（3D物理模型）**
  - 游泳时使用独立消耗模型（水平阻力 + 垂直上浮/下潜功率 + 静态踩水功率）
  - 引入负重阈值与非线性惩罚、湿重效应等参数（用于更拟真的水中负浮力体验）

### 改进
- **游泳速度检测可靠性**
  - 统一改为使用 `GetOrigin()` 的位置差分测速（避免游泳命令通过 `PrePhys_SetTranslation` 位移导致 `GetVelocity()` 为0）
  - 游泳消耗计算与每秒速度显示共用同一套差分速度输入，避免“显示速度=0但实际在动”的错觉

### 修复
- 修复EnforceScript `Math.Round()` 仅支持单参数导致的编译错误（调试输出保留两位小数改为手动缩放）

## [2.7.0] 

### 新增
- **代码模块化重构（Modular Refactoring）**
  - 创建10个模块化组件，提高代码可维护性
  - **SCR_CollapseTransition.c** - "撞墙"阻尼过渡模块
  - **SCR_StaminaConstants.c** - 常量定义模块（262行）
  - **SCR_StaminaHelpers.c** - 辅助函数模块（94行）
  - 所有常量定义已提取到独立模块
  - 所有辅助函数已提取到独立模块

### 改进
- **代码结构优化**
  - PlayerBase.c: 2037行 → 1464行（减少573行，约28%）
  - SCR_RealisticStaminaSystem.c: 1483行 → 1144行（减少339行，约23%）
  - 代码结构更清晰，模块职责单一
- **模块化组件集成**
  - 所有模块化组件已成功集成到主控制器
  - 保持向后兼容，所有公共API不变
  - 代码编译通过，功能完整

### 技术改进
- 实现模块化架构，提高代码可维护性
- 提取常量定义到独立模块（StaminaConstants）
- 提取辅助函数到独立模块（StaminaHelpers）
- 优化代码组织，符合单一职责原则

## [2.6.0] 

### 新增
- **趴下休息时的负重优化（Prone Rest Weight Reduction）**
  - 当角色趴下休息时，负重影响降至最低（地面支撑装备重量）
  - 重装兵趴下时能够快速恢复体力，提供合理的战术选择
  - 使用 `ECharacterStance.PRONE` 检测姿态（通过 `GetStance()` 方法）
- **跳跃冷却机制**
  - 添加3秒冷却时间（15个更新周期），防止重复触发
  - 与翻越冷却机制保持一致的设计模式
- **连续跳跃惩罚机制（无氧欠债）**
  - 检测3秒内的连续跳跃，每次额外增加50%消耗
  - 第一次跳：3.5%，第二次跳：5.25%，第三次跳：7.0%
  - 有效防止"兔子跳"战术滥用
- **低体力禁用跳跃**
  - 体力 < 10% 时禁用跳跃（肌肉在力竭时无法提供爆发力）
  - 符合生理学特性

### 改进
- **Sprint 速度系统优化（统一增量模型）**
  - Sprint 速度增量从 15% 提升到 30%，确保负重状态下仍有明显差距
  - Sprint 计算完全基于 Run 的完整逻辑（双稳态-平台期、5秒阻尼过渡等）
  - Sprint 负重惩罚系数从 20% 降为 15%（模拟爆发力克服阻力）
  - 重构 Sprint 计算逻辑，确保始终比 Run 快 30% 的固定阶梯
  - **效果**：28KG 负重下，Run 3.6 m/s vs Sprint 4.7 m/s（差距 1.1 m/s）
- **Sprint 体力消耗优化**
  - Sprint 消耗倍数从 2.5x 提升到 3.0x，平衡速度提升带来的优势
  - 确保玩家不能长时间使用 Sprint，只能作为战术爆发
- **跳跃和翻越消耗优化（动态负重倍率）**
  - 跳跃基础消耗从 3% 提升到 3.5%
  - 翻越起始消耗从 1.5% 提升到 2%
  - 持续攀爬消耗：每秒 1%（每 0.2 秒 0.002）
  - 使用动态负重倍率：`实际消耗 = 基础消耗 × (currentWeight / 90.0) ^ 1.5`
  - 30KG 负重时，跳跃消耗约 4.6%，翻越起始消耗约 2.7%
- **跳跃和翻越 UI 交互增强**
  - 跳跃后更新 Exhaustion 信号（基础 0.1 + 负重加成，最多 0.2）
  - 触发深呼吸音效和视觉模糊效果，增强感官反馈

### 修复
- **Sprint 和 Run 速度差异不明显**
  - 修复 Sprint 独立计算导致的逻辑脱节
  - Sprint 现在完全基于 Run 的完整逻辑进行加乘
  - 确保在任何负重和体力状态下，Sprint 都比 Run 快 30%

### 技术改进
- 重构 Sprint 速度计算逻辑（统一增量模型）
- 实现动态负重倍率计算函数 `CalculateActionCost()`
- 实现连续跳跃惩罚机制（无氧欠债）
- 实现低体力禁用跳跃机制
- 优化跳跃和翻越的体力消耗计算（基于总重量而非额外负重）

## [2.5.0]

### 新增
- **地形系数系统 (Terrain Factor η)**
  - 集成地形系数到 Pandolf 模型，根据地面类型动态调整消耗
  - 地形系数范围：铺装路面 1.0 → 深雪 2.1-3.0
  - 基于地面密度检测实现地形类型识别
  - 性能优化：静止时降低检测频率至 2 秒
- **静态负重站立消耗 (Static Standing Cost)**
  - 集成 Pandolf 静态项公式，负重下站立时减缓恢复速度
  - 空载时每秒恢复 1%，负重 40kg 时每秒仅恢复 0.4%
  - 模拟现实中背负装备站立时的静态等长收缩
- **Santee 下坡修正模型**
  - 精确处理下坡时的体力消耗（超过 -15% 时需"刹车"）
  - 修正系数：`μ = 1.0 - [G·(1 - G/15)/2]`
  - 缓下坡（-5%）消耗减少约 2-3%，陡下坡（-15%+）消耗回升
- **Givoni-Goldman 跑步模式切换**
  - 速度 >2.2 m/s 时自动切换到跑步能量消耗模型
  - 跑步效率比步行低，消耗随速度平方剧增
- **恢复启动延迟机制**
  - 负重下恢复速率提升需静止 3 秒后才生效
  - 防止"短促冲刺+立即静止"循环滥用
  - 模拟心率下降和呼吸调整的生理过程
- **网络同步容差优化**
  - 连续偏差累计触发机制（2 秒容差），避免地形 LOD 差异导致的频繁拉回
  - 速度插值平滑处理（0.5 秒过渡），减少服务器端同步时的抖动
- **生理上限溢出处理（疲劳积累系统）**
  - 超出最大消耗的体力转化为疲劳积累
  - 疲劳降低最大体力上限（最多 30%）
  - 需要长时间休息（60 秒）才能开始恢复疲劳
- **UI 信号桥接系统（官方 UI 特效集成）**
  - 通过 SignalsManagerComponent 手动更新 "Exhaustion" 信号
  - 让官方 UI 特效（视觉模糊、呼吸声）响应自定义体力系统状态
  - 智能映射：基础模糊（体力剩余量）+ 瞬时模糊（运动强度）+ 崩溃期强化（体力 < 25%）
  - 当体力掉到 25% 时，信号值超过 0.45，立即触发视觉模糊效果
  - 完美衔接拟真模型的崩溃点（25%）和官方 UI 特效阈值（45%）

### 改进
- **性能优化**：地形检测频率根据移动状态动态调整
- **代码结构**：修复编译错误，优化代码组织

### 技术改进
- 实现地形系数查询和缓存机制
- 实现静态消耗计算（仅在速度接近 0 时）
- 实现 Santee 下坡修正（二次函数代替线性判定）
- 实现 Givoni-Goldman 跑步模型切换
- 实现恢复延迟跟踪机制
- 实现网络同步偏差累计系统
- 实现疲劳积累和恢复系统
- 实现 UI 信号桥接系统（SignalsManagerComponent 集成）

## [2.2.0]

### 新增
- **双稳态-应激性能模型（Dual-State Stress Performance Model）**
  - 平台期（25%-100%体力）：保持恒定目标速度（3.7 m/s），模拟意志力克服早期疲劳
  - 衰减期（0%-25%体力）：速度平滑下降到跛行速度，使用SmoothStep过渡（25%-5%缓冲区）
- **5秒阻尼过渡（"撞墙"瞬间优化）**
  - 在体力触及25%临界点时，使用5秒时间阻尼过渡，让玩家感觉"腿越来越重"
  - 避免速度瞬间跳变（"引擎突然断油"），提供平滑的疲劳体验
  - 使用SmoothStep函数实现渐进式速度下降
- **坡度自适应步幅逻辑（坡度-速度负反馈）**
  - 上坡时自动降低目标速度（每度降低2.5%），换取更持久的续航
  - 模拟现实中人爬坡时自动缩短步幅的行为
- **坡度消耗非线性增长（幂函数）**
  - 使用 `(gradePercent × 0.01)^1.2 × 5.0` 替代线性增长
  - 小坡（5%以下）几乎无感，陡坡才真正吃力，避免Everon缓坡频繁断气
- **体力消耗生理上限（VO2 Max限制）**
  - 每0.2秒最大消耗不超过0.02（每秒最多掉10%）
  - 防止负重+坡度组合导致的数值爆炸

### 改进
- **平滑过渡优化**：将缓冲区间从10%-25%扩展至5%-25%，避免突兀的"撞墙"效果
- **"撞墙"瞬间优化**：在体力触及25%临界点时，添加5秒阻尼过渡机制
  - 使用时间插值（SmoothStep）实现渐进式速度下降
  - 让玩家感觉"腿越来越重"，而不是"引擎突然断油"
  - 速度在5秒内从3.7 m/s逐渐降到约2.2 m/s
- **负重影响优化**：负重主要影响"油耗"（体力消耗）而非直接降低"最高档位"（速度）
  - 负重对速度的影响从50%降低到20%
  - 30kg负重时仍能短时间跑3.7 m/s，只是消耗更快
- **重载下恢复优化**：负重时恢复速率提升（0-30kg：10%提升，30-40.5kg：30%提升）
  - 模拟士兵通过深呼吸快速调整的能力
  - 避免重装冲刺后的"跛行"惩罚太久

### 技术改进
- 实现SmoothStep函数（三阶多项式插值）用于平滑过渡
- 5秒阻尼过渡机制：时间跟踪变量（`m_bInCollapseTransition`, `m_fCollapseTransitionStartTime`）
- 坡度自适应函数：`CalculateSlopeAdjustedTargetSpeed()`
- 非线性坡度消耗：`CalculateGradeMultiplier()` 使用幂函数
- 生理上限限制：在体力消耗计算后应用 `MAX_DRAIN_RATE_PER_TICK`

## [2.1.0]

### 新增
- 参数优化功能，达到2英里15分27秒目标
- 精确数学模型实现（α=0.6，Pandolf模型）
- 完整的原生体力系统覆盖机制
- 高频监控系统（50ms间隔）

### 改进
- 速度倍数从0.885提升至0.920（满体力速度4.78 m/s）
- 速度平方项系数从0.0003降低至0.0001
- 使用目标体力值而非当前体力值进行计算，避免原生系统干扰
- 优化监控频率，平衡性能和拦截效果

### 修复
- 修复原生体力系统干扰问题
- 修复体力恢复速度异常问题
- 修复监控机制中的逻辑问题

### 技术改进
- 实现精确的幂函数计算（牛顿法）
- 完整的 Pandolf 模型实现
- 改进的拦截机制（OnStaminaDrain事件覆盖 + 主动监控）

## [2.0.0] 

### 新增
- 动态速度调整系统（根据体力百分比）
- 负重影响系统（负重影响速度）
- 精确数学模型（不使用近似）
- 综合状态显示（速度、体力、倍率）
- 平滑速度过渡机制

### 技术实现
- 使用 `modded class SCR_CharacterStaminaComponent` 扩展体力组件
- 使用 `modded class SCR_CharacterControllerComponent` 显示状态信息
- 通过 `OverrideMaxSpeed(fraction)` 动态设置最大速度倍数

## [1.0.0]

### 新增
- 初始版本
- 固定速度修改功能（50%）
- 速度显示功能（每秒一次）
